<!DOCTYPE html>
<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <title>Cards for Humanity</title>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="lobby.css">
    <link rel="stylesheet" href="game.css">
    <link rel="stylesheet" href="settings.css">
</head>

<body>
    <div id="root">
        <div id="lobby-holder">
            <div id="lobby">
                <div id="logo">CFH</div>
                <input id="player-name-input-lobby" placeholder="Player Name"></input>
                <div id="create-game-button" class="button">Create New Game</div>
                <div id="lobby-list-holder">
                    <div id="game-list-div">
                        <table id="game-list">
                            <tr>
                                <th>Game</th>
                                <th>Player Count</th>
                            </tr>

                            <!-- Games would be dynamically generated by code -->
                        </table>
                    </div>
                    <div>
                        <div id="refresh-button" class="button">â†»</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="game-end-menu" class="game-end-menu holder" hidden>
            <div id="play-again-button" class="button">Play Again</div>
            <div id="exit-button" class="button">Exit to Lobby</div>
        </div>
        <div id="settings-menu" hidden>
            <div id="settings-container">
                <div id="num-settings-container">
                    <div class="num-setting-holder">
                        <div class="num-setting">
                            Max Players
                            <div class="num-setting-input">
                                <input type="number" id="max-players" value="15"></input>
                            </div>
                        </div>
                    </div>
                    <div class="num-setting-holder">
                        <div class="num-setting">
                            Points to Win
                            <div class="num-setting-input">
                                <input type="number" id="points" value="10"></input>
                            </div>
                        </div>
                    </div>
                    <div class="num-setting-holder">
                        <div class="num-setting">
                            Selection Time
                            <div class="num-setting-input">
                                <input type="number" id="max-time" value="45"></input>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="packs-container">
                    Packs
                    <div id="pack-list-div">
                        <table id="pack-list">
                            <!-- Packs are defined in here -->
                        </table>
                    </div>
                </div>
                <div id="settings-buttons-div">
                    <div id="create-game">
                        <div id="confirm-game-button" class="button">Create Game</div>
                        <div id="cancel-game" class="button">Cancel Game</div>
                    </div>
                    <div id="update-settings">
                        <div id="update-settings-button" class="button">Update Settings</div>
                        <div id="cancel-settings" class="button">Exit Settings</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="game-holder" hidden>
            <div id="game" class="game">
                <div id="left-side-div">
                    <div id="players-list">

                    </div>
                    <div id="settings-holder">
                        <div id="game-settings-button" class="button">
                            Open Settings
                        </div>
                        <div id='game-start-button' class='button'>Start Game</div>
                    </div>
                </div>
                <div id="board-holder">
                    <div id="played-div">
                        <div id="black-card-div" class="black-card-div box">
                        </div>
                        <div id="played-cards">
                        </div>
                    </div>
                    <div id="hand-box">
                        <div id="hand-czar-overlay-container">
                            <div id="hand-czar-overlay">
                                <div id="hand-czar-message">
                                    You are the czar!
                                </div>
                            </div>
                        </div>
                        <div id="hand-holder">
                            <div id="hand">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Exported functions to be used in Rust
        // functions are written in JS because working w/ HTML is easier in JS
        function get_current_packs() {
            // We can no longer filter by just what was newly selected
            let ele = document.getElementById("pack-list");
            let output = [];

            for (row of ele.rows) {
                let check_box = row.cells[0].children[0];
                let name = row.cells[1].innerHTML;
                if (check_box && name && check_box.checked)
                    output.push(name)
            }

            return output;
        }

        function add_pack(new_pack, prompts, responses) {
            let element = document.getElementById("pack-list");
            element.innerHTML +=
                `<tr><td><input type="checkbox"></td><td>${new_pack}</td><td>${prompts}</td><td>${responses}</td></tr>`;
        }

        function clear_player_marks(id) {
            document.getElementById(`player-${id}`).classList.remove("czar", "picked");
        }

        function mark_player_played(id) {
            document.getElementById(`player-${id}`).classList.add("picked");
        }

        function mark_player_czar(id) {
            document.getElementById(`player-${id}`).classList.add("czar");
        }

        function update_player_points(id, points) {
            document.getElementById(`player-${id}-points`).innerHTML = points;
        }

        function update_player_name(id, name) {
            document.getElementById(`player-${id}-name`).innerHTML = name;
        }

        function remove_player(id) {
            document.getElementById(`player-${id}`).remove();
        }

        function remove_card_from_hand(index) {
            document.getElementById("hand").children[index].remove();
        }

        function clear_response_cards() {
            document.getElementById("played-cards").innerHTML = "";
        }

        function place_blank_response() {
            document.getElementById("played-cards").innerHTML += `<div class="white-card card"></div>`;
        }

        function clear_servers() {
            document.getElementById("game-list").innerHTML = "<tr><th>Game</th><th>Player Count</th></tr>";
        }

        function disable_hand() {
            document.getElementById('hand').classList.add('disabled');
            document.getElementById('hand-czar-overlay-container').hidden = false;
        }

        function enable_hand() {
            document.getElementById('hand').classList.remove('disabled');
            document.getElementById('hand-czar-overlay-container').hidden = true;
        }

        function show_game_end() {
            document.getElementById("game-end-menu").hidden = false;
        }

        function hide_game_end() {
            document.getElementById("game-end-menu").hidden = true;
        }

        function mark_winner(id) {
            for (child of document.getElementById(`player-${id}-responses`).children) {
                child.classList.add('winner')
            }
        }

        function clear_hand() {
            document.getElementById('hand').innerHTML = '';
        }

        // Events registered after the page has finished loading
        (() => {
            const settings_div = document.getElementById("settings-menu");
            const create_settings_div = document.getElementById("create-game");
            const update_settings_div = document.getElementById("update-settings");
            const shadow_div = document.getElementById('shadow');
            const lobby_div = document.getElementById('lobby-holder');
            const game_div = document.getElementById('game-holder');

            let interactible = true;

            document.getElementById("create-game-button").onclick = () => {
                if (!interactible) return;
                if (!document.getElementById("player-name-input-lobby").value.trim()) {
                    alert("You need a name before you can create a game");
                } else {
                    lobby_div.hidden = true;
                    settings_div.hidden = false;
                    update_settings_div.hidden = true;
                    create_settings_div.hidden = false;
                }
            };

            document.getElementById("cancel-game").onclick = () => {
                lobby_div.hidden = false;
                settings_div.hidden = true;
                shadow_div.hidden = true;
            };

            document.getElementById("cancel-settings").onclick = () => {
                game_div.hidden = false;
                settings_div.hidden = true;
                shadow_div.hidden = true;
            };

            document.getElementById("game-settings-button").onclick = () => {
                if (!interactible) return;
                settings_div.hidden = false;
                game_div.hidden = true;
                update_settings_div.hidden = false;
                create_settings_div.hidden = true;
            };
        })();
    </script>
    <script type='module'>
        import init, { client_main } from './client/client.js';

            async function run() {
                await init(new URL('./client/client_bg.wasm', import.meta.url));

                client_main();
            }

            run();
        </script>
</body>

</html>